<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}ActiveLife{% endblock %}</title>

  <!-- üì¶ Bootstrap y estilos base -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/carrito.css') }}">

  {% block extra_css %}{% endblock %}
</head>

<body>
  <!-- üîù Barra superior -->
  <div class="topbar">
    <div class="topbar-right">
      <!-- üõí Bot√≥n del carrito -->
      <a href="javascript:void(0)" id="btn-carrito" class="btn btn-success position-relative me-2">
        Mi Carrito
        <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          0
        </span>
      </a>

      <!-- üîê Sesi√≥n -->
      {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}" class="btn-session logout">Cerrar sesi√≥n</a>
      {% else %}
        <a href="{{ url_for('auth.login') }}" class="btn-session login">Iniciar sesi√≥n</a>
      {% endif %}
    </div>

    <!-- üåô Modo oscuro -->
    <div class="modo-switch-container">
      <label class="switch">
        <input type="checkbox" id="modoSwitch" {% if tema_usuario == 'claro' %}checked{% endif %}>
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <!-- üìö Sidebar + Contenido -->
  <div class="d-flex" id="wrapper">
    <!-- üìö Sidebar -->
    <div class="bg-dark border-right" id="sidebar-wrapper">
      <div class="list-group-item list-group-item-action bg-dark text-white sidebar-title">ActiveLife</div>

      <div class="list-group list-group-flush">
        {% if current_user.is_authenticated %}
        <div class="list-group-item bg-dark text-white sidebar-static">
          Bienvenido {{ current_user.username }}<br />
          {{ current_user.role|capitalize }}
        </div>
        {% endif %}

        <!-- üß≠ Navegaci√≥n principal -->
        <a href="{{ url_for('main.index') }}" class="list-group-item list-group-item-action bg-dark text-white {% if active_page == 'index' %}active{% endif %}">Inicio</a>
        <a href="{{ url_for('main.perfil') }}" class="list-group-item list-group-item-action bg-dark text-white {% if active_page == 'perfil' %}active{% endif %}">Mi Perfil</a>
        <a href="{{ url_for('main.tienda') }}" class="list-group-item list-group-item-action bg-dark text-white {% if active_page == 'tienda' %}active{% endif %}">Tienda Online</a>
        <a href="{{ url_for('main.biblioteca') }}" class="list-group-item list-group-item-action bg-dark text-white {% if active_page == 'coleccion' %}active{% endif %}">Mi Biblioteca</a>

        <!-- üß∞ Gesti√≥n interna -->
        {% if current_user.is_authenticated and current_user.role in ['admin', 'editor'] %}
          <a href="{{ url_for('productos.lista_productos') }}" class="list-group-item list-group-item-action bg-dark text-white">Gesti√≥n de Productos</a>
        {% endif %}
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <a href="{{ url_for('usuarios.lista_usuarios') }}" class="list-group-item list-group-item-action bg-dark text-white">Gesti√≥n de Usuarios</a>
        {% endif %}

        <!-- üõçÔ∏è Secci√≥n de compras -->
        {% if current_user.is_authenticated %}
          {% if current_user.role == 'admin' %}
            <a href="{{ url_for('ventas_admin.lista_ventas') }}" class="list-group-item list-group-item-action bg-dark text-white">Historial de Compras</a>
          {% else %}
            <a href="{{ url_for('ventas_admin.mis_compras') }}" class="list-group-item list-group-item-action bg-dark text-white">Mis Compras</a>
          {% endif %}
        {% endif %}

        <a href="{{ url_for('main.acerca') }}" class="list-group-item list-group-item-action bg-dark text-white {% if active_page == 'acerca' %}active{% endif %}">Acerca de Nosotros</a>
      </div>
    </div>

    <!-- üìÑ Contenido principal -->
    <div class="container-fluid">
      <button class="btn btn-primary" id="menu-toggle">‚ò∞ Men√∫</button>
      {% block content %}{% endblock %}
    </div>
  </div>

  <!-- üõçÔ∏è Panel lateral del carrito -->
  <div id="carrito-panel" class="carrito-panel">
    <div class="carrito-header">
      <h5>üõí Mi Carrito</h5>
      <button id="cerrar-carrito" class="btn btn-sm btn-danger">‚úñ</button>
    </div>

    <div id="carrito-items" class="carrito-items text-white text-center">
      <p class="text-muted mt-3">Tu carrito est√° vac√≠o</p>
    </div>

    <div class="carrito-footer">
      <div>Total: <span id="carrito-total">$0.00</span></div>
      <button id="btn-checkout" class="btn btn-success w-100 mt-2">Finalizar compra</button>
    </div>
  </div>

  <!-- üü¢ Fondo oscuro para el carrito -->
  <div id="overlay-carrito"
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
              background:rgba(0,0,0,0.5); z-index:2500; transition:opacity 0.3s;">
  </div>

  <!-- üü© Mensaje de confirmaci√≥n -->
  <div id="cart-feedback">Agregado al carrito üõí</div>

  <!-- üìú Footer -->
  <footer class="bg-dark text-white py-3 mt-5">
    <div class="container text-center">
      <p>&copy; 2025 ActiveLife. Todos los derechos reservados. INGxIngeniosos</p>
      <p>"Adri√°n √Ålvarez, Erik L√≥pez, Kevin L√≥pez"</p>
    </div>
  </footer>

  <!-- ‚öôÔ∏è Scripts principales -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  {% block extra_js %}{% endblock %}

  <!-- üåê URLs globales -->
  <script>
    window.__URLS__ = {
      carrito_ver      : "{{ url_for('carrito.carrito_ver') }}",
      carrito_agregar  : "{{ url_for('carrito.carrito_agregar') }}",
      carrito_quitar   : "{{ url_for('carrito.carrito_quitar') }}",
      carrito_conteo   : "{{ url_for('carrito.carrito_conteo') }}",
      biblioteca       : "{{ url_for('main.biblioteca') }}",
    };
  </script>

  <!-- üß© L√≥gica del carrito centralizada -->
  <script src="{{ url_for('static', filename='js/cart.js') }}"></script>
<script>
async function refrescarConteoCarrito() {
  try {
    const res = await fetch("{{ url_for('carrito.carrito_conteo') }}", { cache: "no-store" });
    const data = await res.json();
    const badge = document.getElementById("cart-badge");
    if (badge) {
      badge.textContent = data.count;
      badge.style.display = data.count > 0 ? "inline-flex" : "none";
    }
  } catch (err) {
    console.error("‚ùå Error al obtener conteo:", err);
  }
}

// üîÅ Llamar siempre al iniciar
document.addEventListener("DOMContentLoaded", refrescarConteoCarrito);

// Escuchar si el carrito cambia (para refrescar sin recargar)
document.addEventListener("carrito:eliminado", refrescarConteoCarrito);
document.addEventListener("carrito:agregado", refrescarConteoCarrito);
</script>

<script>
document.getElementById("btn-checkout")?.addEventListener("click", () => {
  // Cierra el panel
  const panel = document.getElementById("carrito-panel");
  const overlay = document.getElementById("overlay-carrito");
  if (panel) panel.classList.remove("show");
  if (overlay) {
    overlay.style.opacity = "0";
    setTimeout(() => { overlay.style.display = "none"; }, 300);
  }
  document.body.style.overflow = "";

  // üîÅ Redirige al carrito completo
  window.location.href = "{{ url_for('carrito.carrito_ver') }}";
});
</script>

</body>
</html>
