{% extends 'base.html' %}
{% block title %}Perfil - {{ user[0] }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/perfil.css') }}">
{% endblock %}

{% block content %}
<div class="perfil-container {{ user[5] }}">
    
    <!-- üñºÔ∏è Banner -->
    <div class="banner"
         style="background-image: url('{{ url_for('static', filename='IMG/perfiles/' + (user[4] if user[4] else 'banner_default.jpg')) }}')">
        <div class="perfil-header">
            <button id="editarPerfilBtn" class="btn-editar">Editar Perfil</button>
        </div>
    </div>

    <!-- üë§ Informaci√≥n del usuario -->
    <div class="perfil-info">
        <img id="fotoPerfil"
             src="{{ url_for('static', filename='IMG/perfiles/' + (user[3] if user[3] else 'default.png')) }}"


             class="foto-perfil">
        <h2 id="username">{{ user[0] }}</h2>
        <p id="descripcion">{{ user[2] if user[2] else 'Sin descripci√≥n a√∫n.' }}</p>
    </div>

    <!-- üìù Formulario de edici√≥n -->
    <form id="formEditarPerfil"
          action="{{ url_for('main.editar_perfil_usuario') }}"
          method="POST"
          enctype="multipart/form-data"
          class="editar-form"
          style="display:none;">

        <div class="form-group">
            <label for="usernameInput">Nombre de usuario:</label>
            <input type="text" id="usernameInput" name="username" value="{{ user[0] }}" required>
        </div>

        <div class="form-group">
            <label for="descripcionInput">Descripci√≥n:</label>
            <textarea id="descripcionInput" name="descripcion" rows="2">{{ user[2] }}</textarea>
        </div>

        <div class="form-group">
            <label for="fotoInput">Foto de perfil:</label>
            <input type="file" id="fotoInput" name="foto_perfil" accept="image/*">
        </div>

        <div class="form-group">
            <label for="bannerInput">Banner:</label>
            <input type="file" id="bannerInput" name="banner" accept="image/*">
        </div>

        <div class="form-group">
            <button type="submit" class="btn-guardar">Guardar cambios</button>
        </div>
    </form>

    <!-- üéÆ Biblioteca de juegos -->
     
    <div class="perfil-juegos">
        <h3>Juegos en tu biblioteca</h3>
        <div class="juegos-grid">
            {% for j in juegos %}
<a href="{{ url_for('main.juego_detalle', id=j.id, origen='perfil') }}" class="juego-card-link">
    <div class="juego-card">
        
        <img src="{{ url_for('static', filename='IMG/productos/' + j.imagen) }}">
        <p>{{ j.nombre }}</p>
        <small>Adquirido el {{ j.fecha_adquirido }}</small>
    </div>
</a>
            {% else %}
                <p class="sin-juegos">No tienes juegos a√∫n</p>
            {% endfor %}
            

        </div>
<div id="modalFoto" class="modal-foto">
  <span class="cerrar-modal">&times;</span>
  <img id="modalImagen" src="" alt="">
</div>

</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

    /* ======================================
       1) MOSTRAR / OCULTAR FORMULARIO
    ====================================== */
    const btnEditar = document.getElementById("editarPerfilBtn");
    const form = document.getElementById("formEditarPerfil");

    if (btnEditar && form) {
        btnEditar.addEventListener("click", (e) => {
            e.stopPropagation();  // evita abrir el banner
            form.style.display = form.style.display === "none" ? "block" : "none";
            form.scrollIntoView({ behavior: "smooth" });
        });
    }

    /* ======================================
       2) GUARDAR CAMBIOS (AJAX)
    ====================================== */
    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            const res = await fetch(form.action, {
                method: "POST",
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                document.querySelector(".perfil-info h2").textContent = data.username;
                document.querySelector(".perfil-info p").textContent = data.descripcion || "Sin descripci√≥n";

                if (data.foto_perfil) {
                    document.querySelector(".foto-perfil").src = "/static/IMG/" + data.foto_perfil;
                }
                if (data.banner) {
                    document.querySelector(".banner").style.backgroundImage = "url('/static/IMG/" + data.banner + "')";
                }

                alert("‚úÖ Perfil actualizado correctamente");
                form.style.display = "none";

            } else {
                alert("‚ùå Error al guardar cambios");
            }
        });
    }

    /* ======================================
       3) MODAL DE FOTO (FOTO / BANNER)
    ====================================== */
    const foto = document.getElementById("fotoPerfil");
    const banner = document.querySelector(".banner");
    const modal = document.getElementById("modalFoto");
    const modalImg = document.getElementById("modalImagen");
    const cerrar = document.querySelector(".cerrar-modal");

    function abrirModal(src) {
        modalImg.src = src;
        modal.classList.add("show");
    }

    function cerrarModal() {
        modal.classList.remove("show");
    }

    if (foto) {
        foto.style.cursor = "pointer";
        foto.addEventListener("click", (e) => {
            e.stopPropagation();
            abrirModal(foto.src);
        });
    }

    if (banner) {
        banner.style.cursor = "pointer";
        banner.addEventListener("click", () => {
            // obtiene la URL real del background
            let bg = window.getComputedStyle(banner).backgroundImage;
            const match = bg.match(/url\(["']?(.*?)["']?\)/);
            if (match && match[1]) abrirModal(match[1]);
        });
    }

    if (cerrar) {
        cerrar.addEventListener("click", cerrarModal);
    }

    modal.addEventListener("click", (e) => {
        if (e.target === modal) cerrarModal();
    });

});
</script>
{% endblock %}
